{
  try {
    List<String> active_topologys=clusterState.active_storms();
    if (active_topologys == null) {
      return;
    }
    Map<String,Object> totalMsg=new HashMap<String,Object>();
    for (    String topologyId : active_topologys) {
      MetricKVMsg topologyMetricMsg=MetricKVMsg.getMetricKVMsg(topologyId,clusterState);
      Map<String,Object> ret=topologyMetricMsg.convertToKVMap();
      if (ret.size() > 0)       totalMsg.putAll(ret);
    }
    if (totalMsg.size() > 0) {
      if (client instanceof AlimonitorClient) {
        ((AlimonitorClient)client).setMonitorName(ConfigExtension.getAlmonUserMetricName(data.getConf()));
        ((AlimonitorClient)client).setCollectionFlag(0);
        ((AlimonitorClient)client).setErrorInfo("");
      }
      client.send(totalMsg);
    }
  }
 catch (  Exception e) {
    LOG.warn("Failed to upload user define metric data",e);
  }
}
