{
  LOG.info("Receive " + topologyname + ", uploadedJarLocation:"+ uploadedJarLocation);
  long start=System.nanoTime();
  try {
    checkTopologyActive(data,topologyname,false);
  }
 catch (  AlreadyAliveException e) {
    LOG.info(topologyname + " is already exist ");
    throw e;
  }
catch (  Throwable e) {
    LOG.info("Failed to check whether topology is alive or not",e);
    throw new TException(e);
  }
  int counter=data.getSubmittedCount().incrementAndGet();
  String topologyId=Common.topologyNameToId(topologyname,counter);
  data.getPendingSubmitTopoloygs().put(topologyId,null);
  try {
    Map<Object,Object> serializedConf=(Map<Object,Object>)JStormUtils.from_json(jsonConf);
    if (serializedConf == null) {
      LOG.warn("Failed to serialized Configuration");
      throw new InvalidTopologyException("Failed to serilaze topology configuration");
    }
    serializedConf.put(Config.TOPOLOGY_ID,topologyId);
    serializedConf.put(Config.TOPOLOGY_NAME,topologyname);
    Map<Object,Object> stormConf;
    stormConf=NimbusUtils.normalizeConf(conf,serializedConf,topology);
    LOG.info("Normalized configuration:" + stormConf);
    data.getTopologyNettyMgr().setTopology(stormConf);
    Map<Object,Object> totalStormConf=new HashMap<Object,Object>(conf);
    totalStormConf.putAll(stormConf);
    StormTopology normalizedTopology=NimbusUtils.normalizeTopology(stormConf,topology,true);
    Common.validate_basic(normalizedTopology,totalStormConf,topologyId);
    StormClusterState stormClusterState=data.getStormClusterState();
    setupStormCode(conf,topologyId,uploadedJarLocation,stormConf,normalizedTopology);
    setupZkTaskInfo(conf,topologyId,stormClusterState);
    LOG.info("Submit for " + topologyname + " with conf "+ serializedConf);
    makeAssignment(topologyname,topologyId,options.get_initial_status());
  }
 catch (  FailedAssignTopologyException e) {
    StringBuilder sb=new StringBuilder();
    sb.append("Fail to sumbit topology, Root cause:");
    if (e.getMessage() == null) {
      sb.append("submit timeout");
    }
 else {
      sb.append(e.getMessage());
    }
    sb.append("\n\n");
    sb.append("topologyId:" + topologyId);
    sb.append(", uploadedJarLocation:" + uploadedJarLocation + "\n");
    LOG.error(sb.toString(),e);
    data.getPendingSubmitTopoloygs().remove(topologyId);
    throw new TopologyAssignException(sb.toString());
  }
catch (  InvalidParameterException e) {
    StringBuilder sb=new StringBuilder();
    sb.append("Fail to sumbit topology ");
    sb.append(e.getMessage());
    sb.append(", cause:" + e.getCause());
    sb.append("\n\n");
    sb.append("topologyId:" + topologyId);
    sb.append(", uploadedJarLocation:" + uploadedJarLocation + "\n");
    LOG.error(sb.toString(),e);
    data.getPendingSubmitTopoloygs().remove(topologyId);
    throw new InvalidParameterException(sb.toString());
  }
catch (  InvalidTopologyException e) {
    LOG.error("Topology is invalid. " + e.get_msg());
    data.getPendingSubmitTopoloygs().remove(topologyId);
    throw e;
  }
catch (  Throwable e) {
    StringBuilder sb=new StringBuilder();
    sb.append("Fail to sumbit topology ");
    sb.append(e.getMessage());
    sb.append(", cause:" + e.getCause());
    sb.append("\n\n");
    sb.append("topologyId:" + topologyId);
    sb.append(", uploadedJarLocation:" + uploadedJarLocation + "\n");
    LOG.error(sb.toString(),e);
    data.getPendingSubmitTopoloygs().remove(topologyId);
    throw new TopologyAssignException(sb.toString());
  }
 finally {
    double spend=(System.nanoTime() - start) / 1000000.0d;
    SimpleJStormMetric.updateHistorgram("submitTopologyWithOpts",spend);
    LOG.info("submitTopologyWithOpts {} spend {}ms",topologyname,spend);
  }
}
