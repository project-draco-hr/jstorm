{
  LOG.info("Receive " + topologyname + ", uploadedJarLocation:"+ uploadedJarLocation);
  try {
    checkTopologyActive(data,topologyname,false);
  }
 catch (  AlreadyAliveException e) {
    LOG.info(topologyname + " is already exist ");
    throw e;
  }
catch (  Exception e) {
    LOG.info("Failed to check whether topology is alive or not",e);
    throw new TException(e);
  }
  int counter=data.getSubmittedCount().incrementAndGet();
  String topologyId=topologyname + "-" + counter+ "-"+ TimeUtils.current_time_secs();
  Map<Object,Object> serializedConf=(Map<Object,Object>)JStormUtils.from_json(jsonConf);
  if (serializedConf == null) {
    LOG.warn("Failed to serialized Configuration");
    throw new InvalidTopologyException("Failed to serilaze topology configuration");
  }
  serializedConf.put(Config.STORM_ID,topologyId);
  Map<Object,Object> stormConf;
  try {
    stormConf=NimbusUtils.normalizeConf(conf,serializedConf,topology);
  }
 catch (  Exception e1) {
    String errMsg=JStormUtils.getErrorInfo("Failed to commit topologystormId: " + topologyId + " uploadedJarLocation: "+ uploadedJarLocation+ ", due to failed to normalize configuration",e1);
    LOG.info(errMsg);
    throw new TException(errMsg);
  }
  Map<Object,Object> totalStormConf=new HashMap<Object,Object>(conf);
  totalStormConf.putAll(stormConf);
  StormTopology newtopology=new StormTopology(topology);
  Common.validate_basic(newtopology,totalStormConf,topologyId);
  try {
    StormClusterState stormClusterState=data.getStormClusterState();
    setupStormCode(conf,topologyId,uploadedJarLocation,stormConf,newtopology);
    setupZkTaskInfo(conf,topologyId,stormClusterState);
    TopologyAssignEvent assignEvent=new TopologyAssignEvent();
    assignEvent.setTopologyId(topologyId);
    assignEvent.setScratch(false);
    assignEvent.setTopologyName(topologyname);
    TopologyAssign.push(assignEvent);
  }
 catch (  IOException e) {
    String errMsg=JStormUtils.getErrorInfo("Fail to sumbit topology, stormId: " + topologyId + " uploadedJarLocation: "+ uploadedJarLocation+ ", failed mkAssignments.",e);
    LOG.info(errMsg);
    throw new TException(errMsg);
  }
catch (  Exception e) {
    String errMsg=JStormUtils.getErrorInfo("Failed to commit topologystormId: " + topologyId + " uploadedJarLocation: "+ uploadedJarLocation+ ", failed mkAssignments.",e);
    LOG.info(errMsg);
    throw new TException(errMsg);
  }
  LOG.info("Received topology submission for " + topologyname + " with conf "+ serializedConf);
}
