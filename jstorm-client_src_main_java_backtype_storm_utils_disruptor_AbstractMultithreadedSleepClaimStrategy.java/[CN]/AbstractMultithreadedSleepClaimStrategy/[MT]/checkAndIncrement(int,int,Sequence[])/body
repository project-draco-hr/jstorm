{
  for (; ; ) {
    long sequence=claimSequence.get();
    if (hasAvailableCapacity(sequence,availableCapacity,gatingSequences)) {
      long nextSequence=sequence + delta;
      if (claimSequence.compareAndSet(sequence,nextSequence)) {
        return nextSequence;
      }
    }
 else {
      throw InsufficientCapacityException.INSTANCE;
    }
  }
}
