{
  String topologyId=event.getTopologyId();
  LOG.info("Determining assignment for " + topologyId);
  TopologyAssignContext context=prepareTopologyAssign(event);
  Set<ResourceWorkerSlot> assignments=null;
  if (!StormConfig.local_mode(nimbusData.getConf())) {
    IToplogyScheduler scheduler=schedulers.get(DEFAULT_SCHEDULER_NAME);
    assignments=scheduler.assignTasks(context);
  }
 else {
    assignments=mkLocalAssignment(context);
  }
  Assignment assignment=null;
  Map<String,String> nodeHost=getTopologyNodeHost(context.getCluster(),context.getOldAssignment(),assignments);
  Map<Integer,Integer> startTimes=getTaskStartTimes(context,nimbusData,topologyId,context.getOldAssignment(),assignments);
  String codeDir=StormConfig.masterStormdistRoot(nimbusData.getConf(),topologyId);
  assignment=new Assignment(codeDir,assignments,nodeHost,startTimes);
  StormClusterState stormClusterState=nimbusData.getStormClusterState();
  stormClusterState.set_assignment(topologyId,assignment);
  NimbusUtils.updateTaskHbStartTime(nimbusData,assignment,topologyId);
  if (context.getAssignType() == TopologyAssignContext.ASSIGN_TYPE_REBALANCE || context.getAssignType() == TopologyAssignContext.ASSIGN_TYPE_MONITOR)   NimbusUtils.updateMetricsInfo(nimbusData,topologyId,assignment);
 else   metricsMonitor(event);
  LOG.info("Successfully make assignment for topology id " + topologyId + ": "+ assignment);
  return assignment;
}
